name: Generate AutoUpdater.NET XML

on:
  release:
    types: [published] # 当有新的 Release 发布时触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 确保有写入权限来推送 gh-pages 分支

    steps:
      - name: Get latest release info
        id: release_info
        uses: actions/github-script@v6
        with:
          script: |
            const { data: release } = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // 找到以 .zip 结尾的资源文件
            const asset = release.assets.find(a => a.name.endsWith('.zip'));
            if (!asset) {
              core.setFailed('No .zip asset found in the latest release.');
              return;
            }

            // 输出版本号 (去掉'v'前缀)
            core.setOutput('version', release.tag_name.replace('v', ''));
            // 输出 .zip 文件的直接下载链接
            core.setOutput('url', asset.browser_download_url);
            // 输出 Release 页面的 URL 作为 changelog
            core.setOutput('changelog_url', release.html_url);

      - name: Create update.xml
        run: |
          echo '<?xml version="1.0" encoding="UTF-8"?>' > update.xml
          echo '<item>' >> update.xml
          echo "    <version>${{ steps.release_info.outputs.version }}</version>" >> update.xml
          echo "    <url>${{ steps.release_info.outputs.url }}</url>" >> update.xml
          # 关键修改：直接使用 Release 页面的 URL
          echo "    <changelog>${{ steps.release_info.outputs.changelog_url }}</changelog>" >> update.xml
          echo '    <mandatory>false</mandatory>' >> update.xml
          echo '</item>' >> update.xml

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: . # 发布当前目录
          publish_branch: gh-pages # 推送到 gh-pages 分支
          # 确保只推送 update.xml 文件，并覆盖旧文件
          # 移除 force_orphan: true, 采用更温和的更新方式
          keep_files: false # 每次推送前清理旧文件，确保分支上只有最新的 update.xml
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
